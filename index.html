<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>Family tree generator | Medieval</title>
		<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script> 
		<script type="text/javascript" src="lib/jquery-ui-1.10.2.custom.min.js"></script>
		<script type="text/javascript" src="lib/primitives.min.js"></script>
		<link rel="stylesheet" type="text/css" href="https://bootswatch.com/4/united/bootstrap.min.css">
		<link rel="stylesheet" type="text/css" href="css/style.css">
	</head>
	<body>
		<div class="row">
			<div class="col-lg-4" style="background-color: #eee;">
				<pre id="log" style="font-size: 10px; overflow-y: scroll;"><button onclick="viewCity(populateTown())" class="btn btn-primary btn-block">Новый город</button>

</pre>
			</div>
			<div class="col-lg-8" id="viewblock">
				<div id="basicdiagram" style="width: 100%; height: 100%;" ></div>
			</div>
		</div>
		<script type="text/javascript">

			$(function(){
				$("#basicdiagram").height($(document).height()-16);
				$("#log").height($(document).height()-16);
			})
			
			console.log = function(str) {
				$('#log').append(str+'\n');
			}


    


    function rand(ar) {
        return ar[Math.floor(Math.random() * ar.length)];
    }
    /**
     * Shuffles array in place.
     * @param {Array} a items An array containing the items.
     */
    function shuffle(a) {
        var j, x, i;
        for (i = a.length - 1; i > 0; i--) {
            j = Math.floor(Math.random() * (i + 1));
            x = a[i];
            a[i] = a[j];
            a[j] = x;
        }
    }
    var start = {
        first: ["Ил", "Эл", "Ё", "Ге", "Джи", "Ро", "Ми", "Ар", "Ха", "Хе", "А", "Ка", "Эш", "Са", "И", "Е", "Эн", "Эм", "Ва", "Ал", "Кон", "О", "Ли", "Ле", "Ла", "Ло", "Э"],
        last: ["Ра", "Кви", "Ма", "Пот", "Дам", "Фин", "Си", "Ро", "Гон", "Э", "Ло", "Лу", "Ка", "Эл", "Эш", "Ар", "Джи", "О", "Бу", "Ху", "А", "Ан", "Ар", "Ше", "Нор", "Рой", "Пу"],
        city: ["Хо", "Ло", "О", "Нью", "Эд", "Нор", "Дуб", "Бе", "Ли", "Ман", "Ре"]
    };
    var middle = {
        first: ["", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "рми", "и", "на", "э", "а", "е", "не", "ле", "хе", "ни", "р", "з", "с", "ми", "си", "ек", "екс", "эк", "экс", "ста", "ли", "л"],
        last: ["", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "зе", "фин", "вен", "ле", "р", "л", "т", "бле", "не", "лма", "ла", "ва", "х", "п", "зм", "ман", "па", "сей", "ба"],
        city: ["", "г", "нг", "нд", "ин", "че", "вер", "л"]
    };
    var end = {
        first: ["я", "н", "ни", "рва", "ри", "на", "ар", "ко", "а", "и", "э", "онд", "ли", "лий", "лия", "та", "тин", "ег", "андр"],
        last: ["рин", "дор", "клоу", "элл", "фой", "ер", "ган", "дур", "илл", "хан", "фор", "ор", "ин", "арт", "нс", "с", "анд", "ид", "а", "ан", "рд", "ан"],
        city: ["смит", "дон", "форд", "касл", "бург", "виз", "ин", "фаст", "пул", "стир", "вилль"]
    };
    function randomName(t) {
        return rand(start[t]) + rand(middle[t]) + rand(end[t]);
    }
    var genders = ["мужской", "женский"];
    function randomGender() {
        return genders[Math.round(Math.random())];
    }
    function randomAge(min, max) {
        return Math.round(Math.random() * (max - min) + min);
    }

    var hairs = [
        {
            name: "рыжие",
            code: 'G',
            priority: 0
        },
        {
            name: "блонд",
            code: 'W',
            priority: 1
        },
        {
            name: "русые",
            code: 'R',
            priority: 2
        },
        {
            name: "каштановые",
            code: 'K',
            priority: 2
        },
        {
            name: "чёрные",
            code: 'B',
            priority: 3
        }
    ];
    var eyes = [
        {
            name: "голубые",
            code: 'L',
            priority: 1
        },
        {
            name: "карие",
            code: 'R',
            priority: 2
        },
        {
            name: "чёрные",
            code: 'B',
            priority: 2
        },
        {
            name: "зелёные",
            code: 'G',
            priority: 0
        },
        {
            name: "серые",
            code: 'Y',
            priority: 1
        }
    ];
    
    var constitutions = [
        {
            name: "эктоморф",
            code: 'A',
            weightFactor: 0.9,
            heightFactor: 1.1,
        },
        {
            name: "мезоморф",
            code: 'N',
            weightFactor: 1,
            heightFactor: 1,
        },
        {
            name: "эндоморф",
            code: 'H',
            weightFactor: 1.1,
            heightFactor: 0.9,
        }
    ];

    function randomHair() {
        return rand(hairs);
    }
    
    function randomEye() {
        return rand(eyes);
    }
    
    function randomConstitution() {
        return rand(constitutions);
    }

    function randomGenome(gender, motherGenome, fatherGenome) {
        if (motherGenome) {
            var motherGenes = motherGenome.split('|');
            var motherHairGene = rand(motherGenes[0].split(''));
            var motherEyeGene = rand(motherGenes[1].split(''));
            var motherHeightGenes = motherGenes[2].split(',').map(function(val) { return rand(val.split('')); });
            var motherConstitutionGene = rand(motherGenes[3].split(''));
            
            var hair = [motherHairGene.toUpperCase()];
            var eye = [motherEyeGene.toUpperCase()];
            var height = [];
            for (var i in motherHeightGenes) {
                if (motherHeightGenes[i]) {
                    height.push([motherHeightGenes[i].toUpperCase()]);
                }
            }
            var constitution = [motherConstitutionGene.toUpperCase()];
            
            if (fatherGenome) {
                var fatherGenes = fatherGenome.split('|');
                var fatherHairGene = rand(fatherGenes[0].split('')).toUpperCase();
                var motherHairPriority = 0;
                for (var i in hairs) {
                    if (hairs[i].code === hair[0]) {
                        motherHairPriority = hairs[i].priority;
                        break;
                    }
                }
                var fatherHairPriority = 0;
                for (var i in hairs) {
                    if (hairs[i].code === fatherHairGene) {
                        fatherHairPriority = hairs[i].priority;
                        break;
                    }
                }
                if (fatherHairPriority > motherHairPriority) {
                    hair = [fatherHairGene.toUpperCase(), hair[0].toLowerCase()];
                } else {
                    hair = [hair[0], fatherHairGene.toLowerCase()];
                }
                var fatherEyeGene = rand(fatherGenes[1].split(''));
                var motherEyePriority = 0;
                for (var i in eyes) {
                    if (eyes[i].code === eye[0]) {
                        motherEyePriority = eyes[i].priority;
                        break;
                    }
                }
                var fatherEyePriority = 0;
                for (var i in eyes) {
                    if (eyes[i].code === fatherEyeGene) {
                        fatherEyePriority = eyes[i].priority;
                        break;
                    }
                }
                if (fatherEyePriority > motherEyePriority) {
                    eye = [fatherEyeGene.toUpperCase(), eye[0].toLowerCase()];
                } else {
                    eye = [eye[0], fatherEyeGene.toLowerCase()];
                }
                var fatherHeightGenes = fatherGenes[2].split(',').map(function(val) { return rand(val.split('')); });
                for (var i in fatherHeightGenes) {
                    if (fatherHeightGenes[i]) {
                        if (Math.random() < 0.5) {
                            height[i] = [height[i][0].toUpperCase(), fatherHeightGenes[i].toLowerCase()];
                        } else {
                            height[i] = [fatherHeightGenes[i].toUpperCase(), height[i][0].toLowerCase()];
                        }
                    }
                }
                var fatherConstitutionGene = rand(fatherGenes[3].split(''));
                if (Math.random() < 0.5) {
                    constitution = [constitution[0], fatherConstitutionGene.toLowerCase()];
                } else {
                    constitution = [fatherConstitutionGene.toUpperCase(), constitution[0].toLowerCase()];
                }
            }
            
            var genome = "";
            genome += hair.join('')+'|';
            var hairName = '';
            for (var i in hairs) {
                if (hairs[i].code === hair[0]) {
                    hairName = hairs[i].name;
                    break;
                }
            }
            genome += eye.join('')+'|';
            var eyeName = '';
            for (var i in eyes) {
                if (eyes[i].code === eye[0]) {
                    eyeName = eyes[i].name;
                    break;
                }
            }
            var heightValue = gender === 'мужской' ? 175 : 163;
            for (var i in height) {
                genome += (i > 0 ? ',' : '') + height[i].join('');
                if (height[i][0] === 'B') {
                    heightValue += 3;
                } else {
                    heightValue -= 3;
                }
            }
            genome += '|';
            var constitutionName = '';
            var weightValue = 0;
            genome += constitution.join('');
            for (var i in constitutions) {
                if (constitutions[i].code === constitution[0]) {
                    constitutionName = constitutions[i].name;
                    weightValue = (gender === 'мужской' ? 75 : 60)*constitutions[i].weightFactor*(1+((Math.random()-0.5)/6));
                    heightValue *= constitutions[i].heightFactor*(1+((Math.random()-0.5)/6));
                    break;
                }
            }
            return {
                genome: genome,
                hair: hairName,
                eye: eyeName,
                constitution: constitutionName,
                height: Math.round(heightValue),
                weight: Math.round(weightValue),
            };
        } else {
            var genome = "";
            var hair = randomHair();
            genome += hair.code + randomHair().code.toLowerCase()+'|';
            var eye = randomEye();
            genome += eye.code + randomEye().code.toLowerCase()+'|';
            var height = gender === 'мужской' ? 175 : 160;
            for (var i = 0; i < 5; i++) {
                var heightGene = rand(['B', 'S']);
                if (heightGene === 'B') {
                    height += 3;
                } else {
                    height -= 3;
                }
                genome += (i > 0 ? ',' : '') + heightGene+rand(['b', 's']);
            }
            genome += '|';
            var constitution = randomConstitution();
            genome += constitution.code+randomConstitution().code.toLowerCase();
            var weight = (gender === 'мужской' ? 75 : 60)*constitution.weightFactor*(1+((Math.random()-0.5)/6));
            height *= constitution.heightFactor*(1+((Math.random()-0.5)/6));
            return {
                genome: genome,
                hair: hair.name,
                eye: eye.name,
                constitution: constitution.name, 
                height: Math.round(height),
                weight: Math.round(weight),
            };
        }
    }

    var professions = [
        ["охотник", false],
        ["художник", "художница"],
        [false, "проститутка"],
        ["певец", "певица"],
        "торговец",
        "продавец",
        ["охранник", false],
        ["каменщик", false],
        ["столяр", false],
        "фермер",
        "мыловар",
        ["ювелир", false],
        ["камнерез", false],
        ["кузнец"],
        "повар",
        "пивовар",
        ["бармен", "официантка"],
        ["хозяин таверны", "хозяйка таверны"],
        ["плотник", false],
        "резчик по кости",
        ["учёный", false],
        ["бандит", "воровка"],
        "рэйнджер",
        "животновод",
        "наёмник",
        ["местный дурачок", false],
        "учитель",
        ["священник", "монашка"],
        ["гончар", false],
        ["мельник", false],
        ["стеклодув", false],
        ["жестянщик", false],
        ["рыбак", false],
    ];
    var professionsChildren = [
        ["тупой мальчик", "тупая девочка"],
        ["красивый мальчик", "красивая девочка"],
        ["храбрый мальчик", false],
        ["талантливый мальчик", "талантливая девочка"],
        ["умный мальчик", "умная девочка"],
        ["хилый мальчик", "хилая девочка"],
        ["сильный мальчик", false],
        ["хулиган", "хулиганка"],
        ["обычный мальчик", "обычная девочка"],
        ["добрый мальчик", "добрая девочка"],
    ];
    function randomProfession(person) {

        if (person.age() < 6) {
            return person.gender === "мужской" ? "мальчик" : "девочка";
        }
        var prof = rand(person.age() < 16 ? professionsChildren : professions);
        if (typeof prof !== "string") {
            var i = person.gender === 'мужской' ? 0 : 1;
            if (prof[i]) {
                prof = prof[i];
            } else {
                return randomProfession(person);
            }
        }
        for (var i in person.traits) {
            var trait = person.traits[i];
            for (var j in traits) {
                var traitProto = traits[j];
                if (traitProto.name !== trait) {
                    continue;
                }
                if (traitProto.blockedProfessions && traitProto.blockedProfessions.indexOf(prof) !== -1) {
                    return randomProfession(person);
                }
                break;
            }
        }
        return prof;
    }
    var genomeTraits = [
        {
            name: "красивый",
            cancels: ["некрасивый", "толстый"],
        },
        {
            name: "некрасивый",
        },
        {
            name: "умный",
            cancels: ["глупый"],
        },
        {
            name: "талантливый",
            cancels: ["глупый"],
        },
        {
            name: "глупый",
        },
        {
            name: "сильный",
            cancels: ["хилый"],
        },
        {
            name: "хилый",
        },
        {
            name: "психопат",
        }
    ];
    var traits = [
        {
            name: "смелый",
            minAge: 10,
        },
        {
            name: "красивый",
            blockedTraits: ["некрасивый", "толстый", "одноглазый", "однорукий", "одноногий"],
            minAge: 3,
            genetical: true,
        },
        {
            name: "некрасивый",
            blockedTraits: ["красивый"],
            blockedProfessions: ["красивый мальчик", "красивая девочка", "проститутка"],
            minAge: 3,
            genetical: true,
        },
        {
            name: "набожный",
            blockedTraits: ["похотливый", "психопат"],
            blockedProfessions: ["проститутка"],
            minAge: 10,
        },
        {
            name: "похотливый",
            blockedTraits: ["набожный"],
            minAge: 10,
        },
        {
            name: "игривый",
            blockedTraits: ["депрессивный", "психопат"],
            minAge: 2,
        },
        {
            name: "депрессивный",
            blockedTraits: ["игривый", "психопат"],
            minAge: 10,
        },
        {
            name: "толстый",
            blockedTraits: ["красивый", "быстрый", "стройный", "худой"],
            blockedProfessions: ["рэйнджер", "наёмник"],
            genetical: true,
            minAge: 5,
        },
        {
            name: "одноглазый",
            blockedTraits: ["красивый"],
            chance: 0.05,
        },
        {
            name: "однорукий",
            blockedTraits: ["красивый"],
            chance: 0.05,
        },
        {
            name: "изуродованный",
            blockedTraits: ["красивый"],
            chance: 0.05,
        },
        {
            name: "одноногий",
            blockedTraits: ["быстрый", "красивый"],
            chance: 0.05,
        },
        {
            name: "романтичный",
            blockedTraits: ["психопат"],
            minAge: 10,
        },
        {
            name: "умный",
            blockedTraits: ["тупой"],
            blockedProfessions: ["местный дурачок", "тупой мальчик", "тупая девочка"],
            minAge: 3,
            genetical: true,
        },
        {
            name: "тупой",
            blockedTraits: ["умный", "психопат", "талантливый"],
            blockedProfessions: ["талантливый мальчик", "талантливая девочка", "умная девочка", "умный мальчик", "учёный", "учитель"],
            minAge: 3,
            genetical: true,
        },
        {
            name: "талантливый",
            blockedTraits: ["тупой"],
            blockedProfessions: ["местный дурачок", "тупой мальчик", "тупая девочка"],
            minAge: 3,
            genetical: true,
        },
        {
            name: "быстрый",
            blockedTraits: ["одноногий", "толстый", "хилый"],
            blockedProfessions: ["хилый мальчик", "хилая девочка"],
            minAge: 3,
        },
        {
            name: "сильный",
            blockedTraits: ["хилый", "худой"],
            blockedProfessions: ["хилый мальчик", "хилая девочка"],
            minAge: 6,
            genetical: true,
        },
        {
            name: "хилый",
            blockedTraits: ["сильный", "быстрый"],
            blockedProfessions: ["стеклодув", "охранник", "наёмник", "рэйнджер", "охотник", "каменщик", "столяр", "ювелир", "камнерез", "кузнец", "плотник", "резчик по кости", "бандит", "воровка", "сильный мальчик"],
            genetical: true,
        },
        {
            name: "психопат",
            blockedTraits: ["тупой", "романтичный", "депрессивный", "игривый", "набожный", "добрый"],
            blockedGenders: ["женский"],
            blockedProfessions: ["добрый мальчик", "добрая девочка"],
            minAge: 5,
            maxAge: 15,
            chance: 0.5,
            genetical: true,
        },
        {
            name: "педофил",
            blockedGenders: ["женский"],
            minAge: 15,
            chance: 0.5,
            blockedProfessions: ["рыбак", "охотник", "художник", "художница", "торговец", "продавец", "охранник", "каменщик", "столяр", "фермер", "мыловар", "ювелир", "камнерез", "кузнец", "повар", "пивовар", "бармен", "официантка", "хозяин таверны", "хозяйка таверны", "плотник", "резчик по кости", "учёный", "рэйнджер", "животновод", "наёмник", "гончар", "мельник", "стеклодув", "жестянщик"],
        },
        {
            name: "аутист",
            chance: 0.1,
            maxAge: 7,
            blockedProfessions: ["рыбак", "охотник", "проститутка", "певец", "певица", "торговец", "продавец", "охранник", "каменщик", "столяр", "фермер", "мыловар", "ювелир", "камнерез", "кузнец", "повар", "пивовар", "бармен", "официантка", "хозяин таверны", "хозяйка таверны", "плотник", "резчик по кости", "учёный", "бандит", "воровка", "рэйнджер", "животновод", "наёмник", "учитель", "священник", "гончар", "мельник", "стеклодув", "жестянщик", "храбрый мальчик", "талантливый мальчик", "талантливая девочка", "умный мальчик", "умная девочка", "обычный мальчик", "обычная девочка", "хулиган", "хулиганка"],
        },
        {
            name: "добрый",
            blockedTraits: ["злой", "психопат", "педофил"],
            blockedProfessions: ["бандит", "воровка", "хулиган", "хулиганка"],
        },
        {
            name: "злой",
            blockedTraits: ["злой"],
            blockedProfessions: ["добрый мальчик", "добрая девочка"],
        }

    ];
    function checkTrait(person, result, trait) {
        if (trait.genetical) {
            return false;
        }
        if (trait.blockedTraits) {
            for (var i in trait.blockedTraits) {
                if (result.indexOf(trait.blockedTraits[i]) !== -1) {
                    return false;
                }
                if (person.traits.indexOf(trait.blockedTraits[i]) !== -1) {
                    return false;
                }
            }
        }
        if (trait.blockedProfessions && trait.blockedProfessions.indexOf(person.profession) !== -1) {
            return false;
        }
        if (trait.blockedGenders && trait.blockedGenders.indexOf(person.gender) !== -1) {
            return false;
        }
        if (trait.minAge && person.age() < trait.minAge) {
            return false;
        }
        if (trait.maxAge && person.age() > trait.maxAge) {
            return false;
        }
        if (trait.chance && Math.random() > trait.chance) {
            return false;
        }

        return true;
    }
    function randomTraits(person, count) {
        if (person.age() < 3) {
            return [];
        }
        shuffle(traits);
        var result = [];
        var traitsCount = count || Math.round(Math.random() * (person.age()) < 16 ? 1 : 3);
        for (var i = 0; i < traits.length && result.length < traitsCount; i++) {
            var trait = traits[i];
            if (checkTrait(person, result, trait)) {
                result.push(trait.name);
            }
        }
        return result;
    }
    var currentYear = 0;
    function uniqueId() {
        if (!this.marked) {
            this.marked = [];
        }

        var value = '0x' + parseInt((new Date()).getMilliseconds() + Math.round(Math.random() * 100000), 16);
        if (this.marked.indexOf(value) !== -1) {
            return uniqueId();
        } else {
            this.marked.push(value);
            return value;
        }
    }
    function randomNPC(lastName, gender, minBirth, maxBirth, minAge, motherGenome, fatherGenome) {
        lastName = lastName || randomName('last');
        gender = gender || randomGender();
        minBirth = minBirth || 0;
        maxBirth = maxBirth === 0 ? 0 : (maxBirth || currentYear);
        minAge = minAge || 0;
        var birth = randomAge(minBirth, maxBirth);
        var lifeTime = (Math.random() < 0.5) ? randomAge(0, 16) : randomAge(0, 80);
        if (minAge) {
            lifeTime = Math.max(minAge, lifeTime);
        }
        var dead = ((birth + lifeTime) <= currentYear) ? (birth + lifeTime) : false;
        var age = (dead ? dead : currentYear) - birth;
        var traits = [];
        var genome = randomGenome(gender, motherGenome ? motherGenome.genome : false, fatherGenome ? fatherGenome.genome : false);
        var imt = genome.weight/((genome.height/100)*(genome.height/100));
        if (imt >= 28) {
            traits.push("толстый");
        } else if (imt < 20 && imt > 18) {
            traits.push("стройный");
        } else if (imt <= 18) {
            traits.push("худой");
        }
        var additionalTraits = randomTraits({profession: profession, age: function () {return age}, gender: gender, traits: traits});
        for (var i in additionalTraits) {
            traits.push(additionalTraits[i]);
        }
        var profession = randomProfession({age: function () {return age}, gender: gender, traits: traits});
        return {
            id: uniqueId(),
            firstName: randomName('first'),
            lastName: lastName,
            girlName: lastName,
            name: function () {
                return this.firstName + ' ' + this.lastName + (this.girlName !== this.lastName ? ' (' + this.girlName + ')' : '');
            },
            gender: gender,
            genome: genome,
            height: function () {
                var stopAge = this.gender === 'мужской' ? 19 : 15;
                return this.age() >= stopAge ? this.genome.height : Math.round(50 + (this.genome.height - 50) * this.age() / stopAge);
            },
            weight: function () {
                var stopAge = 20;
                return this.age() >= stopAge ? this.genome.weight : Math.round(3 + (this.genome.weight - 3) * this.age() / stopAge);
            },
            profession: profession,
            professionBackup: false,
            traits: traits,
            birth: birth,
            dead: dead,
            migrated: false,
            deathReason: dead ? randomDeathReason() : false,
            age: function () {
                return (this.dead ? this.dead : currentYear) - this.birth;
            },
            pregrant: false,
            pregrantFrom: false,
            force: function () {
                var force = 0;
                if (this.age() >= 5 && this.age() < 10) {
                    force += 1;
                }
                if (this.age() >= 10 && this.age() < 15) {
                    force += 2;
                }
                if (this.age() >= 15 && this.age() < 20) {
                    force += 4;
                }
                if (this.age() >= 20 && this.age() < 30) {
                    force += 5;
                }
                if (this.age() >= 30 && this.age() < 40) {
                    force += 4;
                }
                if (this.age() >= 40 && this.age() < 50) {
                    force += 3;
                }
                if (this.age() >= 50 && this.age() < 60) {
                    force += 2;
                }
                if (this.age() >= 60 && this.age() < 70) {
                    force += 1;
                }


                for (var i = 0; i < this.traits.length; i++) {
                    var trait = this.traits[i];
                    switch (trait) {
                        case "хилый":
                        case "толстый":
                        case "худой":
                        case "аутист":
                        case "добрый":
                            force -= 1;
                            break;
                        case "злой":
                        case "сильный":
                        case "психопат":
                            force += 1;
                            break;
                    }
                }

                switch (this.profession) {
                    case "рэйнджер":
                    case "охотник":
                    case "сильный мальчик":
                    case "охранник":
                    case "наёмник":
                    case "бандит":
                    case "столяр":
                    case "кузнец":
                    case "камнерез":
                    case "каменщик":
                    case "хулиган":
                    case "хулиганка":
                        force += 1;
                        break;
                    case "хилый мальчик":
                    case "хилая девочка":
                    case "добрый мальчик":
                    case "добрая девочка":
                        force -= 1;
                        break;
                }

                if (this.gender === "мужской") {
                    force *= 2;
                }

                return force;
            },
            die: function (reason) {
                this.dead = currentYear;
                this.deathReason = reason;
                var husband = null;
                for (var i in this.spouces) {
                    if (!this.spouces[i].dead) {
                        husband = this.spouces[i];
                        break;
                    }
                }
                if (husband) {
                    husband.traits.push("вдовец");
                }
            },
            addTrait: function(trait) {
                if (this.traits.indexOf(trait) === -1) {
                    this.traits.push(trait);
                }
            },
            hasTrait: function(trait) {
                return this.traits.indexOf(trait) !== -1;
            },
            spouces: [],
            childrens: [],
            parents: [],
            jailed: false
        };
    }
    function randomHero() {
        return randomNPC(false, false, currentYear - 50, currentYear - 16);
    }
    var deathReasons = [
        "проблемы со здоровьем",
        "несчастный случай",
        "неизвестная болезнь",
    ];
    function randomDeathReason() {

        var type = rand(deathReasons);
        return {
            type: type
        };
    }
    function heSheIt(gender) {
        switch (gender) {
            case 'мужской':
                return 'Он';
            case 'женский':
                return 'Она';
            default:
                return 'Оно';
        }
    }
    function parseLine(text, world) {
        return text
                .replace(/%hero%:name/g, world.hero.name())
                .replace(/%hero%:age/g, world.hero.age())
                .replace(/%hero%:profession/g, world.hero.profession)

                .replace(/%hero%:childTrait/g, world.hero.childTrait)
                .replace(/%hero%:heSheIt/g, heSheIt(world.hero.gender))
                .replace(/%city%:name/g, world.city.name)

                .replace(/%city%:population/g, world.city.population)

                .replace(/%city%:occupation/g, world.city.occupation)

                .replace(/%heroPartner%:name/g, world.heroPartner.name())
                .replace(/%heroPartner%:age/g, world.heroPartner.age())
                .replace(/%heroPartner%:profession/g, world.heroPartner.profession)

                .replace(/%heroPartner%:childTrait/g, world.heroPartner.childTrait)
                .replace(/%heroPartner%:heSheIt/g, heSheIt(world.heroPartner.gender));
    }
    function randomCity() {
        return {
            name: randomName('city'),
            population: Math.round(Math.random() * 1000 + 100),
            occupation: 'вольный город'
        };
    }
    function randomWorld() {
        return {
            hero: randomHero(),
            city: randomCity(),

            heroPartner: randomNPC()
        };
    }
    var scenario = {
        start: {
            text: '%hero%:name, %hero%:profession was burn in %city%:name %hero%:age years ago. %hero%:heSheIt was a %hero%:childTrait.',
            next: ['idle'],
        },

        idle: {
            text: '%hero%:name with a %heroPartner%:name, %heroPartner%:age years old %heroPartner%:profession, spend time out of town together.',
            next: ['playing', 'talking', 'date'],
        },

        playing: {
            text: '%hero%:name playing with a %heroPartner%:name, and they get some fun.',
            next: ['dragonAttack'],
        },

        talking: {
            text: '%hero%:name talking wit a %heroPartner%:name, and its was be an interesting talk',
            next: ['dragonAttack'],
        },

        date: {
            text: '%hero%:name raped %heroPartner%:name so hard',
            next: ['dragonAttack'],
        },

        dragonAttack: {
            text: 'When the %city%:occupation %city%:name was attacked by the dragon, they returned to city and seeing houses in fire.',
            next: ['heroGoingToFight']
        },

        heroGoingToFight: {
            text: '%hero%:name attacked a dragon and then...',
            next: ['heroDiesByDragon', 'heroKillsDragon']
        },

        heroDiesByDragon: {
            text: '%hero%:heSheIt was killed. So dragon burn %city%:name to fire and all of %city%:population people was dyed.',
            next: ['end', 'parnterAlive']
        },

        parnterAlive: {
            text: '%heroPartner%:name was stand alone in a ruins of %city%:name looking at %hero%:name`s dead body and crying.',
            next: ['end']
        },

        heroKillsDragon: {
            text: 'our brave %hero%:profession was stroke down the dragon! What a famous victory!',
            next: ['end', 'partnerDead']
        },

        partnerDead: {
            text: 'But before last strike dragon kills a %heroPartner%:name! %hero%:name stand alone in a ruins of %city%:name looking at %heroPartner%:profession dead body and crying.',
            next: ['end']
        },

        end: {
            text: 'This is how %hero%:name`s story ends.',
            next: false
        }
    };
    function makeStory() {
        var world = randomWorld();
        var currentStep = 'start';
        while (currentStep) {
            console.log(parseLine(scenario[currentStep].text, world));
            currentStep = rand(scenario[currentStep].next);
        }
    }

    function populateTown(city, years)
    {
        
        years = years || 100;
        if (!city) {
            currentYear = 0;
            city = {
                town: randomCity(),
                people: {},
                currentYear: 0,
                nobles: {
                    head: null,
                }
            };
            var colonialFamiliesCount = randomAge(3, 6);
            for (var i = 0; i < colonialFamiliesCount; i++) {
                var person = randomNPC(false, 'мужской', -30, -18, 99);
                while (person.profession === "священник") {
                    person.profession = randomProfession(person);
                }
                var wife = randomNPC(false, 'женский', person.birth - 2, Math.min(person.birth + 15, -16), 50);
                while (wife.profession === "проститутка" || wife.profession === "монашка") {
                    wife.profession = randomProfession(wife);
                }
                wife.lastName = person.lastName;
                city.people[person.id] = person;
                city.people[wife.id] = wife;
                person.spouces.push(wife);
                wife.spouces.push(person);
                if (!city.nobles.head) {
                    person.professionBackup = person.profession;
                    person.profession = "староста";
                    city.nobles.head = person;
                }
            }
        }

        for (currentYear = city.currentYear; currentYear < city.currentYear + years; currentYear++) {
            console.log('Год: ' + currentYear);
            
            for (var id in city.people) {
                var person = city.people[id];

                if (person.dead || person.migrated !== false)
                    continue;

                // baby -> children evolution
                if (person.age() === 6) {
                    person.profession = randomProfession(person, 6);
                    var newTrait = (Math.random() < 0.5) ? randomTraits(person, 1)[0] : false;
                    if (newTrait) {
                        person.addTrait(newTrait);
                    }
                    console.log(person.name() + ' празднует 6-летие и теперь ' + heSheIt(person.gender) + ' ' + person.profession + (newTrait ? '. Новая черта: ' + newTrait : ''));
                }
                if (person.age() === 16) {
                    person.profession = randomProfession(person, 16);
                    person.professionBackup = person.profession;
                    var newTrait = (Math.random() < 0.5) ? randomTraits(person, 1)[0] : false;
                    if (newTrait) {
                        person.addTrait(newTrait);
                    }
                    console.log(person.name() + ' празднует 16-летие и теперь ' + heSheIt(person.gender) + ' ' + person.profession + (newTrait ? '. Новая черта: ' + newTrait : ''));
                }
                
                // new random trait
                if (Math.random() < 0.01) {
                    var newTrait = randomTraits(person, 1)[0];
                    if (newTrait) {
                        person.addTrait(newTrait);
                        console.log(person.age() + "-летн" + (person.gender === "мужской" ? "ий" : "ая") + " " + person.profession + ' ' + person.name() + ' теперь ' + newTrait);
                    }
                }

                var husband = null;
                for (var i in person.spouces) {
                    if (!person.spouces[i].dead) {
                        husband = person.spouces[i];
                        break;
                    }
                }

                // baby burning
                if (person.pregrant) {
                    var children = randomNPC(person.lastName, false, currentYear, currentYear, false, person.genome, person.pregrantFrom ? city.people[person.pregrantFrom].genome : null);
                    city.people[children.id] = children;
                    person.childrens.push(children);
                    children.parents.push(person);
                    var potentialTraits = [];
                    for (var i = 0; i < person.traits.length; i++) {
                        for (var j = 0; j < genomeTraits.length; j++) {
                            if (genomeTraits[j].name === person.traits[i]) {
                                var trait = genomeTraits[j].name;
                                for (var k = 0; k < potentialTraits.length; k++) {
                                    if (genomeTraits[j].cancels && genomeTraits[j].cancels.indexOf(potentialTraits[k]) !== -1) {
                                        delete potentialTraits[k];
                                    }
                                }
                                potentialTraits.push(trait);
                                break;
                            }
                        }
                    }

                    if (person.pregrantFrom) {
                        
                        var isHusband = false;
                        if (husband) {
                            isHusband = husband.id === person.pregrantFrom;
                        } else {
                            for (var i in person.spouces) {
                                if (person.spouces[i].id === person.pregrantFrom) {
                                    isHusband = true;
                                    break;
                                }
                            }
                        }
                        
                        var father = city.people[person.pregrantFrom];
                        for (var i = 0; i < father.traits.length; i++) {
                            for (var j = 0; j < genomeTraits.length; j++) {
                                if (genomeTraits[j].name === father.traits[i]) {
                                    var trait = genomeTraits[j].name;
                                    for (var k = 0; k < potentialTraits.length; k++) {
                                        if (genomeTraits[j].cancels && genomeTraits[j].cancels.indexOf(potentialTraits[k]) !== -1) {
                                            delete potentialTraits[k];
                                        }
                                    }
                                    potentialTraits.push(trait);
                                    break;
                                }
                            }
                        }

                        if (husband && !isHusband) {
                            // измена
                            console.log(person.name() + ' рожает ' + (children.gender === "мужской" ? 'мальчика' : 'девочку') + ' по имени ' + children.name() + ' от человека по имени ' + city.people[person.pregrantFrom].name() + ', но все думают, что ребёнок от её мужа по имени ' + husband.name());
                        } else if (!isHusband) {
                            // рожает без мужа
                            console.log(person.name() + ' рожает ' + (children.gender === "мужской" ? 'мальчика' : 'девочку') + ' по имени ' + children.name() + ' от ' + city.people[person.pregrantFrom].name() + '. Общественность осуждает её.');
                            person.addTrait("опозоренный");
                        } else {
                            father.childrens.push(children);
                            children.parents.push(father);
                            console.log(person.name() + ' рожает ' + (children.gender === "мужской" ? 'мальчика' : 'девочку') + ' по имени ' + children.name() + ' от своего мужа по имени ' + city.people[person.pregrantFrom].name());
                        }
                    } else {
                        // рожает неизвестно от кого
                        console.log(person.name() + ' рожает ' + (children.gender === "мужской" ? 'мальчика' : 'девочку') + ' ' + children.name() + ' неизвестно от кого! Какой позор!');
                        person.addTrait("опозоренный");
                    }

                    if (potentialTraits.length) {
                        children.addTrait(rand(potentialTraits));
                    }

                    person.pregrant = false;
                    person.pregrantFrom = false;
                    if (children.dead) {
                        console.log(children.name() + ' рождается уже мёртвым');
                    } else {
                        console.log('От рождения '+children.name()+' '+(children.traits.length ? 'имеет особенности: '+children.traits.join(', ') : 'не имеет особенностей'));
                        
                        var chanceToDieAfterBurn = 0.05;
                        if (person.age() < 18) {
                            chanceToDieAfterBurn = 0.1;
                        }
                        if (person.profession === "хилая девочка") {
                            chanceToDieAfterBurn = 0.9;
                        }
                        if (person.profession === "проститутка") {
                            chanceToDieAfterBurn += 0.1;
                        }
                        if (person.hasTrait("хилый")) {
                            chanceToDieAfterBurn += 0.1;
                        }
                        if (person.hasTrait("изнасилованный")) {
                            chanceToDieAfterBurn += 0.3;
                        }
                        if (person.hasTrait("депрессивный")) {
                            chanceToDieAfterBurn += 0.1;
                        }

                        if (Math.random() < chanceToDieAfterBurn) {
                            person.die({type: "умерла при родах"});
                            console.log(person.name() + ' умирает при родах');
                            continue;
                        }
                    }
                } else if (person.gender === 'женский' && person.age() >= 12 && !person.pregrant && person.jailed === false) {
                    // make childrens
                    var chanceToPregrant = 0.01;
                    if (husband && husband.jailed === false && husband.migrated === false) {
                        chanceToPregrant += 0.9;
                    }
                    if (person.profession === "проститутка") {
                        chanceToPregrant += 0.9;
                    }
                    if (person.age() > 35) {
                        chanceToPregrant = 0;
                    } else if (person.age() > 27) {
                        chanceToPregrant /= 4;
                    } else if (person.age() > 23) {
                        chanceToPregrant /= 2;
                    }
                    if (person.hasTrait("набожный")) {
                        chanceToPregrant /= 2;
                    }
                    if (person.hasTrait("некрасивый")) {
                        chanceToPregrant /= 1.5;
                    }
                    if (person.hasTrait("похотливый")) {
                        chanceToPregrant *= 1.5;
                    }
                    if (person.hasTrait("красивый")) {
                        chanceToPregrant *= 1.5;
                    }
                    if (person.hasTrait("изнасилованный")) {
                        chanceToPregrant /= 2;
                    }

                    if (Math.random() < chanceToPregrant) {
                        var chanceToWhoring = 0.01;
                        if (person.hasTrait("похотливый")) {
                            chanceToWhoring += 0.1;
                        }
                        if (person.hasTrait("набожный")) {
                            chanceToWhoring -= 0.8;
                        }
                        if (person.profession === "проститутка") {
                            chanceToWhoring += 1.5;
                        }
                        if (!husband || husband.jailed !== false) {
                            chanceToWhoring += 0.1;
                        }
                        if (husband && husband.hasTrait("некрасивый")) {
                            chanceToWhoring *= 1.5;
                        }
                        if (husband && husband.hasTrait("похотливый")) {
                            chanceToWhoring /= 2;
                        }
                        if (husband && husband.hasTrait("красивый")) {
                            chanceToWhoring /= 1.5;
                        }
                        
                        if (Math.random() < chanceToWhoring) {
                            // find a lover
                            var lovers = [];
                            for (var loverId in city.people) {
                                var lover = city.people[loverId];
                                if (lover.gender !== "мужской" || lover.dead || lover.migrated !== false || lover.age() < 16 || lover.age() > 50 || lover.jailed !== false || lover.hasTrait("некрасивый") || lover.hasTrait("аутист")) {
                                    continue;
                                }

                                var loverParents = lover.parents.map(function(val) { return val.id; });
                                var personParents = person.parents.map(function(val) { return val.id; });
                                var loverClosed = false;
                                for (var i in loverParents) {
                                    var p = loverParents[i];
                                    if (personParents.indexOf(p) !== -1) {
                                        //								console.log(lover.name()+' rejected by shared parent');
                                        loverClosed = true;
                                        break;
                                    }
                                    if (personParents.indexOf(lover.id) !== -1) {
                                        //								console.log(lover.name()+' rejected by father');
                                        loverClosed = true;
                                        break;
                                    }
                                    if (loverParents.indexOf(id) !== -1) {
                                        //								console.log(lover.name()+' rejected by son');
                                        loverClosed = true;
                                        break;
                                    }
                                }
                                if (loverClosed) {
                                    continue;
                                }
                                lovers.push(lover);
                            }
                            if (lovers.length) {
                                var lover = rand(lovers);
                                person.pregrantFrom = lover.id;
                            } else {
                                person.pregrantFrom = false;
                            }
                        } else if (husband && husband.jailed === false) {
                            person.pregrantFrom = husband.id;
                        }
                        if (person.pregrantFrom) {
                            person.pregrant = true;
                            console.log(person.name() + ' беременеет от ' + (husband && person.pregrantFrom === husband.id ? 'своего супруга' : 'любовника') + ' ' + (person.pregrantFrom ? 'по имени ' + city.people[person.pregrantFrom].name() : ''));
                        }
                    }
                }

                // find a wife
                if (person.gender === 'мужской' && person.age() >= 18 && !husband && !person.hasTrait("аутист") && person.jailed === false && person.profession !== "местный дурачок" && person.profession !== "священник") {
                    var chanceToWannaWife = 0.5;
                    if (person.traits.indexOf("психопат") !== -1 ) {
                        chanceToWannaWife /= 2;
                    }
                    if (person.traits.indexOf("педофил") !== -1) {
                        chanceToWannaWife /= 2;
                    }
                    if (person.traits.indexOf("вдовец") !== -1) {
                        chanceToWannaWife /= 2;
                    }
                    if (person.traits.indexOf("романтичный") !== -1) {
                        chanceToWannaWife *= 2;
                    }
                    if (person.traits.indexOf("похотливый") !== -1) {
                        chanceToWannaWife *= 2;
                    }
                    
                    if (Math.random() < chanceToWannaWife) {
                        //					console.log(person.name() + ' ' + person.age() + 'yo finds a wife');

                        // search a free girls
                        var girls = [];
                        for (var girlId in city.people) {
                            var girl = city.people[girlId];
                            if (girl.gender !== 'женский' || girl.dead || girl.migrated !== false || girl.age() <= 16 || girl.profession === "монашка" || girl.profession === "проститутка" || girl.pregrant || girl.age() - 3 > person.age() || girl.jailed !== false) {
                                continue;
                            }
                            if ((girl.hasTrait("вдовец") || girl.hasTrait("изнасилованный") || girl.hasTrait("опозоренный")) && Math.random() < 0.95) {
                                continue;
                            }
                            
                            var girlMarried = false;
                            for (var i in girl.spouces) {
                                var girlHusband = girl.spouces[i];
                                if (!girlHusband.dead) {
                                    girlMarried = true;
                                    break;
                                }
                            }
                            if (girlMarried) {
                                //							console.log(girl.name()+' rejected by married');
                                continue;
                            }

                            var girlParents = girl.parents.map(function(val) { return val.id; });
                            var personParents = person.parents.map(function(val) { return val.id; });

                            var girlClosed = false;
                            for (var i in girlParents) {
                                var p = girlParents[i];
                                if (personParents.indexOf(p) !== -1) {
                                    //								console.log(girl.name()+' rejected by shared parent');
                                    girlClosed = true;
                                    break;
                                }
                                if (personParents.indexOf(girl.id) !== -1) {
                                    //								console.log(girl.name()+' rejected by mother');
                                    girlClosed = true;
                                    break;
                                }
                                if (girlParents.indexOf(id) !== -1) {
                                    //								console.log(girl.name()+' rejected by daughter');
                                    girlClosed = true;
                                    break;
                                }
                            }
                            if (girlClosed) {
                                continue;
                            }

                            if (person.age() - girl.age() > 20 && Math.random() < 0.5) {
                                continue;
                            }

                            girls.push(girl);
                        }

                        //					console.log("finded "+girls.length+" girls");

                        if (girls.length) {
                            // random choise
                            var girl = rand(girls);
                            console.log(person.name() + ' берёт в жёны девушку по имени ' + girl.name());
                            girl.lastName = person.lastName;
                            person.spouces.push(girl);
                            girl.spouces.push(person);
                            husband = girl;
                            // TODO: усыновление 
                        }
                    }
                }

                // random death
                var chanceToRandomDeath = 0.005;
                if (person.age() < 10) {
                    chanceToRandomDeath = 0.02;
                } else if (person.age() > 30) {
                    chanceToRandomDeath = (person.age() - 30) / 500;
                }
                if (["хилый мальчик", "хилая девочка", "проститутка"].indexOf(person.profession) !== -1) {
                    chanceToRandomDeath *= 2;
                }
                if (person.jailed !== false) {
                    chanceToRandomDeath *= 2;
                }
                if (person.traits.indexOf("хилый") !== -1) {
                    chanceToRandomDeath *= 2;
                }
                if (person.traits.indexOf("изнасилованный") !== -1) {
                    chanceToRandomDeath *= 1.5;
                }
                if (person.gender === "мужской") {
                    chanceToRandomDeath *= 1.1;
                }
                if (Math.random() < chanceToRandomDeath) {
                    person.die(randomDeathReason());
                    console.log(person.name() + ' умирает из-за причины: ' + person.deathReason.type);
                    continue;
                }

                // rapes
                if (person.gender === "мужской" && person.age() >= 15 && person.jailed === false) {

                    var psychopath = person.hasTrait("психопат");
                    var paedophile = person.hasTrait("педофил");

                    var chanceToWannaRape = 0.01;
                    if (psychopath) {
                        chanceToWannaRape += 0.5;
                    }
                    if (paedophile) {
                        chanceToWannaRape += 0.2;
                    }
                    if (person.hasTrait("похотливый")) {
                        chanceToWannaRape += 0.1;
                    }
                    if (person.hasTrait("набожный")) {
                        chanceToWannaRape -= 0.9;
                    }
                    if (person.hasTrait("романтичный")) {
                        chanceToWannaRape -= 0.1;
                    }
                    if (person.profession === "хулиган") {
                        chanceToWannaRape += 0.1;
                    }
                    if (person.profession === "бандит") {
                        chanceToWannaRape += 0.1;
                    }

                    if (Math.random() < chanceToWannaRape) {

                        // search victim (paedophiles check)
                        var maxVictimAge = paedophile ? 15 : 27;
                        var minVictimAge = paedophile ? 5 : 15;
                        var victims = [];
                        for (var girlId in city.people) {
                            var girl = city.people[girlId];
                            if (girl.gender !== "женский" && !paedophile) {
                                continue;
                            }
                            if (girl.dead || girl.migrated !== false || girl.age() > maxVictimAge || girl.age() < minVictimAge || girlId === id || (husband && girlId === husband.id) || girl.jailed !== false) {
                                continue;
                            }
                            if (girl.traits.indexOf("некрасивый") !== -1 && Math.random() < 0.9) {
                                continue;
                            }

                            victims.push(girl);
                        }

                        if (victims.length) {

                            // choise victim
                            var victim = null;
                            while (victim === null) {
                                for (var i = 0; i < victims.length; i++) {
                                    var girl = victims[i];
                                    var chance = 0.5 / victims.length;
                                    if (girl.traits.indexOf("красивый") !== -1) {
                                        chance *= 2;
                                    }
                                    if (girl.traits.indexOf("стройный") !== -1) {
                                        chance *= 2;
                                    }
                                    if (girl.traits.indexOf("толстый") !== -1) {
                                        chance /= 2;
                                    }
                                    if (girl.traits.indexOf("худой") !== -1) {
                                        chance /= 1.5;
                                    }
                                    if (girl.force() >= person.force()) {
                                        chance /= 2;
                                    }
                                    if (girl.traits.indexOf("изнасилованный") !== -1) {
                                        chance *= 2;
                                    }
                                    if (girl.traits.indexOf("набожный") !== -1) {
                                        chance /= 1.5;
                                    }
                                    if (Math.random() < chance) {
                                        victim = girl;
                                        break;
                                    }
                                }
                            }
                            // check success
                            var success = victim.force() < person.force();
                            if (success) {

                                // rape
                                console.log(person.age() + "-летний " + person.profession + " по имени " + person.name() + " насилует " + victim.age() + "-летн" + (victim.gender === "мужской" ? "его" : "юю") + " " + victim.profession + ' ' + victim.name());
                                victim.traits.push("изнасилованный");

                                // random death or pregrant
                                if (victim.traits.indexOf("хилый") !== -1 || victim.profession === "мальчик" || victim.profession === "девочка" || victim.profession === "хилая девочка" || victim.profession === "хилый мальчик" || (victim.age() < 17 && Math.random() < 0.5)) {
                                    victim.die({type: "изнасилование", killer: person.id});
                                    console.log(victim.name() + " умирает от изнасилования человеком по имени " + person.name());
                                } else {
                                    if (victim.pregrant && Math.random() < 0.5) {
                                        victim.pregrant = false;
                                        victim.pregrantFrom = false;
                                        console.log(victim.name() + " теряет ребёнка из-за выкидыша, спровоцированного изнасилованием человеком по имени " + person.name());
                                    } else if (victim.gender === "женский" && victim.age() >= 12 && Math.random() < 0.5 && !victim.pregrant) {
                                        victim.pregrant = true;
                                        victim.pregrantFrom = person.id;
                                        console.log(victim.name() + " беременеет от изнасиловавшего её человека по имени " + person.name());
                                    }
                                }
                                // шанс раскрытия
                                var chanceToOpen = 0.1;
                                if (success) {
                                    chanceToOpen += 0.1;
                                }
                                if (person.traits.indexOf("умный") !== -1) {
                                    chanceToOpen -= 0.1;
                                }
                                if (Math.random() < chanceToOpen) {
                                    var victimFather = null;
                                    for (var i in victim.parents) {
                                        var victimParent = victim.parents[i];
                                        if (victimParent.gender === "мужской" && !victimParent.dead && victimParent.migrated === false) {
                                            victimFather = victimParent;
                                            break;
                                        }
                                    }
                                    if (victimFather && Math.random() < 0.5) {
                                        // father of raped one kills raper
                                        person.die({type: "убит", killer: victimFather.id});
                                        console.log(person.name() + " убит человеком по имени " + victimFather.name() + ", " + (victim.gender === 'мужской' ? 'сына' : 'дочь') + " которого он изнасиловал");
                                        continue;
                                    } else {
                                        person.jailed = currentYear;
                                        person.profession = "арестант";
                                        console.log(person.name() + " разоблачён и отправляется в тюрьму за изнасилование");
                                    }
                                }
                            } else if (Math.random() < 0.1) {
                                person.die({type: "убит", killer: victim.id});
                                console.log(person.age() + "-летний " + person.profession + " по имени " + person.name() + " пытается изнасиловать " + victim.age() + "-летн" + (victim.gender === "мужской" ? "его" : "юю") + " " + victim.profession + ' ' + victim.name() + " но " + heSheIt(victim.gender).toLowerCase() + " убивает его");
                                continue;
                            } else {
                                console.log(person.age() + "-летний " + person.profession + " по имени " + person.name() + " пытается изнасиловать " + victim.age() + "-летн" + (victim.gender === "мужской" ? "его" : "юю") + " " + victim.profession + ' ' + victim.name() + " но жертва сбегает");
                            }

                        }
                    }
                }

                // kills
                if (person.age() >= 12 && person.jailed === false) {
                    var chanceToWannaKillSomeone = 0.001;
                    var psychopath = person.hasTrait("психопат");
                    if (psychopath) {
                        chanceToWannaKillSomeone += 0.1;
                    }
                    if (person.hasTrait("злой")) {
                        chanceToWannaKillSomeone += 0.01;
                    }
                    if (person.profession === "бандит") {
                        chanceToWannaKillSomeone += 0.02;
                    }

                    if (Math.random() < chanceToWannaKillSomeone) {
                        // find a victim
                        var victim = false;
                        var victimReason = false;
                        if (person.profession !== "бандит") {
                            if (husband && husband.jailed === false && husband.dead === false && husband.migrated === false && Math.random() < 0.5) {
                                victim = husband;
                                victimReason = rand(["подозрение в измене", "семейная ссора"]);
                            } else if (person.childrens.length && Math.random() < 0.5) {
                                for (var i in person.childrens) {
                                    var children = person.childrens[i];
                                    if (children.dead === false && children.migrated === false && children.jailed === false && Math.random() < 0.5) {
                                        victim = children;
                                        var reasons = ["ссора с ребёнком", "непослушный ребёнок"];
                                        if (person.gender === "мужской") {
                                            reasons.push("подозрение в том, что ребёнок не родной");
                                        }
                                        victimReason = rand(reasons);
                                        break;
                                    }
                                }
                            } else if (person.parents.length) {
                                for (var i in person.parents) {
                                    var parent = person.parents[i];
                                    if (parent.dead === false && parent.jailed === false && parent.migrated === false && Math.random() < 0.5) {
                                        victim = parent;
                                        victimReason = "ссора с родителями";
                                        break;
                                    }
                                }
                            }
                        }
                        if (!victim) {
                            var victims = [];
                            for (var victimId in city.people) {
                                var potenVictim = city.people[victimId];
                                if (victimId !== id && !potenVictim.dead && potenVictim.migrated === false && victimId !== id && potenVictim.age() > 11) {
                                    victims.push(potenVictim);
                                }
                            }
                            if (victims.length) {
                                victim = rand(victims);
                                var reasons = ["ссора", "случайность"];
                                if (person.profession === "бандит" || person.profession === "воровка" || psychopath) {
                                    reasons.push("ограбление"); 
                                }
                                if (person.gender !== victim.gender && victim.age()-3 < person.age()) {
                                    reasons.push("отказ в близости");
                                }
                                if (victim.hasTrait("психопат") || victim.hasTrait("педофил") || victim.profession === "хулиган" || victim.profession === "хулиганка" || victim.profession === "бандит" || victim.profession === "воровка") {
                                    reasons.push("воздаяние за грехи");
                                }
                                if (victim.profession === "староста") {
                                    reasons.push("зависть");
                                }
                                victimReason = rand(reasons);
                            }
                        }
                        if (victim) {
                            // check success
                            var success = victim.force() < person.force();
                            if (success) {
                                victim.die({type: "убит", killer: person.id});
                                console.log(person.age() + "-летн" + (person.gender === "мужской" ? "ий" : "яя") + " " + person.profession + " по имени " + person.name() + " убивает " + victim.age() + "-летн" + (victim.gender === "мужской" ? "его" : "юю") + " " + victim.profession + ' ' + victim.name()+" по причине: "+victimReason);
                                
                                // шанс раскрытия
                                var chanceToOpen = 0.1;
                                if (success) {
                                    chanceToOpen += 0.1;
                                }
                                if (person.traits.indexOf("умный") !== -1) {
                                    chanceToOpen -= 0.1;
                                }
                                if (Math.random() < chanceToOpen) {
                                    person.jailed = currentYear;
                                    person.profession = "арестант";
                                    console.log(person.name() + " отправляется в тюрьму за убийство");
                                }
                            } else if (Math.random() < 0.5) {
                                person.die({type: "убит", killer: victim.id});
                                console.log(person.age() + "-летн" + (person.gender === "мужской" ? "ий" : "яя") + " " + person.profession + " по имени " + person.name() + " пытается убить " + victim.age() + "-летн" + (victim.gender === "мужской" ? "его" : "юю") + " " + victim.profession + ' ' + victim.name() + " по причине: " + victimReason + ", но жертва убивает нападавшего");
                                continue;
                            } else {
                                console.log(person.age() + "-летн" + (person.gender === "мужской" ? "ий" : "яя") + " " + person.profession + " по имени " + person.name() + " пытается убить " + victim.age() + "-летн" + (victim.gender === "мужской" ? "его" : "юю") + " " + victim.profession + ' ' + victim.name() + " по причине: " + victimReason + " но жертва сбегает");
                            }
                        }
                    }
                }

                // suicides
                if (person.age() > 12 && person.traits.indexOf("психопат") === -1) {
                    var chanceToWannaSuicide = 0;
                    if (person.traits.indexOf("изнасилованный") !== -1) {
                        chanceToWannaSuicide += 0.025;
                    }
                    if (person.traits.indexOf("депрессивный") !== -1) {
                        chanceToWannaSuicide += 0.025;
                    }
                    if (person.traits.indexOf("опозоренный") !== -1) {
                        chanceToWannaSuicide += 0.025;
                    }
                    if (person.traits.indexOf("вдовец") !== -1) {
                        chanceToWannaSuicide += 0.0125;
                    }
                    if (person.pregrant && (!person.pregrantFrom || !husband || person.pregrantFrom !== husband.id) && person.profession !== "проститутка") {
                        chanceToWannaSuicide += 0.025;
                    }
                    if (person.jailed !== false) {
                        chanceToWannaSuicide += 0.05;
                    }

                    if (Math.random() < chanceToWannaSuicide) {
                        if (Math.random() < 0.5) {
                            console.log(person.name() + " проводит неудачную попытку самоубийства");
                        } else {
                            console.log(person.name() + " совершает самоубийство");
                            person.die({type: "самоубийство"});
                            continue;
                        }
                    }
                }
                
                // jail free
                if (person.jailed !== false) {
                        var chanceToFree = 0;
                        var delta = currentYear - person.jailed;
                        if (delta > 1 && delta < 5) {
                            chanceToFree = 0.05;
                        } else if (delta >= 5 && delta < 10) {
                            chanceToFree = 0.1;
                        } else if (delta >= 10) {
                            chanceToFree = 0.15;
                        }
                        if (person.hasTrait("красивый")) {
                            chanceToFree += 0.05;
                        }
                        if (person.gender === "женский") {
                            chanceToFree *= 2;
                        }
                        if (person.age() < 18) {
                            chanceToFree *= 2;
                        }

                        if (Math.random() < chanceToFree) {
                            person.jailed = false;
                            person.profession = person.professionBackup;
                            console.log(person.name()+' выходит из тюрьмы отсидев '+delta+' лет');
                        }
                }
                
                // jail break
                if (person.jailed !== false) {
                    var delta = currentYear - person.jailed;
                    if (delta > 0) {
                        var chanceToBreak = 0.01;
                        if (person.hasTrait("умный")) {
                            chanceToBreak += 0.1;
                        }
                        if (person.hasTrait("быстрый")) {
                            chanceToBreak += 0.1;
                        }
                        if (person.hasTrait("сильный")) {
                            chanceToBreak += 0.1;
                        }
                        if (person.hasTrait("слабый")) {
                            chanceToBreak /= 2;
                        }
                        if (person.hasTrait("глупый")) {
                            chanceToBreak /= 2;
                        }
                        if (person.hasTrait("одноногий")) {
                            chanceToBreak /= 2;
                        }
                        if (person.hasTrait("однорукий")) {
                            chanceToBreak /= 2;
                        }
                        if (person.hasTrait("психопат")) {
                            chanceToBreak += 0.1;
                            chanceToBreak *= 2;
                        }
                        if (Math.random() < chanceToBreak) {
                            person.jailed = false;
                            person.profession = person.professionBackup;
                            person.migrated = currentYear;
                            console.log(person.name()+' сбегает из тюрьмы отсидев '+delta+' лет и исчезает из города');
                            continue;
                        }
                    }
                }
                
                // migrations out
                if (person.jailed === false && person.age() > 15 && person.age() < 30 && person.profession !== "староста" && person.profession !== "местный дурачок") {
                    var chanceToMigration = 0.001;
                    if (person.gender === "мужской") {
                        chanceToMigration *= 2;
                    }
                    if (person.age() < 20) {
                        chanceToMigration *= 2;
                    }
                    if (person.hasTrait("опозоренный")) {
                        chanceToMigration *= 2;
                    }
                    if (person.hasTrait("изнасилованный")) {
                        chanceToMigration *= 2;
                    }
                    if (Math.random() < chanceToMigration) {
                        var family = [];
                        if (husband) {
                            family.push(husband);
                        }
                        for (var i in person.childrens) {
                            var children = person.childrens[i];
                            if (!children.dead && children.jailed === false && children.migrated === false && children.age() < 16) {
                                family.push(children);
                            }
                        }
                        person.migrated = currentYear;
                        console.log(person.age()+'-летн'+(person.gender === 'мужской'?'ий':'яя')+' '+person.profession+' '+person.name()+' покидает город в поисках лучшей жизни');
                        for (var i in family) {
                            var closer = family[i];
                            closer.migrated = currentYear;
                            console.log(closer.age()+'-летн'+(closer.gender === 'мужской'?'ий':'яя')+' '+closer.profession+' '+closer.name()+' отправляется вместе с н'+(person.gender === "мужской" ? 'им' : 'ей'));
                        }
                    }
                }
                
            
                // end check person
            }
            
            // migrations in
            if (Math.random() < 0.03) {
                var migrantsCount = Math.round(Math.random()*3)+1;
                for (var i = 0; i < migrantsCount; i++) {
                    var migrant = randomNPC(false, false, currentYear - 30, currentYear - 14, 50);
                    city.people[migrant.id] = migrant;
                    console.log(migrant.age()+'-летн'+(migrant.gender === 'мужской'?'ий':'яя')+' '+migrant.profession+' '+migrant.name()+' прибывает в город!');
                }
            }
            
            // elect new head
            if (!city.nobles.head || city.nobles.head.dead || city.nobles.head.jailed !== false || city.nobles.head.migrated !== false) {
                var candidates = [];
                for (var id in city.people) {
                    var person = city.people[id];
                    if (person.dead !== false || person.migrated !== false || person.profession === "проститутка" || person.profession === "бандит" || person.hasTrait("опозоренный")|| person.jailed !== false || person.hasTrait("аутист")) {
                        continue;
                    }
                    var balls = 0;
                    if (person.gender === "мужской") {
                        balls += 1;
                    }
                    if (person.profession === "учитель" || person.profession === "священник" || person.profession === "учёный" || person.profession === "торговец") {
                        balls += 1;
                    }
                    if (person.profession === "наёмник" || person.profession === "местный дурачок" || person.profession === "охранник") {
                        balls -= 1;
                    }
                    for (var i in person.traits) {
                        var trait = person.traits[i];
                        switch (trait) {
                            case "изнасилованный":
                            case "педофил":
                            case "хилый":
                            case "тупой":
                            case "депрессивный":
                            case "похотливый":
                            case "набожный":
                            case "некрасивый":
                                balls -= 1;
                                break;
                            case "красивый":
                            case "сильный":
                            case "быстрый":
                            case "талантливый":
                            case "умный":
                            case "смелый":
                                balls += 1;
                                break;
                            case "психопат":
                                balls += 5;
                                break;
                        }
                    }
                    if (person.age() < 18) {
                        balls -= 50;
                    } else if (person.age() < 30) {
                        balls -= 10;
                    }
                    candidates.push({person:person, balls:balls});
                }
                var bestCandidates = [];
                var bestBall = -999;
                for (var i in candidates) {
                    var val = candidates[i];
                    var ball = val.balls,
                        person = val.person;
                    if (ball > bestBall) {
                        bestBall = ball;
                        bestCandidates = [person];
                    } else if (ball === bestBall) {
                        bestCandidates.push(person);
                    }
                }
                var head = rand(bestCandidates);
                if (head) {
                    console.log('Новым старостой избирается '+head.age()+'-летн'+(head.gender === 'мужской'?'ий':'яя')+' '+head.profession+' '+head.name());
                    head.profession = "староста";
                    city.nobles.head = head;
                }
            }
            
            // end year
        }

        city.currentYear = currentYear;
        city.town.population = 0;
        city.town.males = 0;
        city.town.females = 0;
        for (var id in city.people) {
            var person = city.people[id];
            if (person.dead === false && person.migrated === false) {
                city.town.population++;
                if (person.gender === "мужской") {
                    city.town.males++;
                } else {
                    city.town.females++;
                }
            }
        }
        return city;
    }
    
    function viewCity(city) {

        var items = [];
        for (var id in city.people) {
            var person = city.people[id];

            var item = {
                id: id,
                title: (person.jailed !== false ? '#' : '') + person.name(),
                label: person.name(),
                description: printNPC(person),
                parents: person.parents.map(function(val) { return val.id; }),
                spouses: person.spouces.map(function(val) { return val.id; })
            };
            items.push(item);
        }

        viewTree(items);
    }
    function printNPC(npc) {
        return npc.age() + ' ' + npc.gender.substr(0,3) + ' ' + npc.height() + 'см.' + '\n' + 'Волосы:' + npc.genome.hair + '\n' + 'Глаза:' + npc.genome.eye + '\n' + 'Черты: ' + npc.traits.join(', ') + '\n' + 'Проф.: ' + npc.profession + '\n' + 'Жизнь: ' + npc.birth + ' - ' + (npc.dead ? npc.dead + '  (' + npc.deathReason.type + ")" : '');
    }
    function viewTree(items) {
        $("#basicdiagram").remove();
        $('#viewblock').append('<div id="basicdiagram" style="width: 100%; height: 4000px; border-style: dotted; border-width: 1px; background-color: white;"></div>');
        var options = new primitives.famdiagram.Config();
        options.items = items;
        options.cursorItem = 2;
        options.linesWidth = 1;
        options.linesColor = "black";
        options.hasSelectorCheckbox = primitives.common.Enabled.False;
        options.normalLevelShift = 20;
        options.dotLevelShift = 20;
        options.lineLevelShift = 20;
        options.normalItemsInterval = 10;
        options.dotItemsInterval = 10;
        options.lineItemsInterval = 10;
        $("#basicdiagram")
                .height($(document).height() - 16)
                .famDiagram(options);
    }


		</script>
	</body>
</html>
